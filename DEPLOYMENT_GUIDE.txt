================================================================================
H∆Ø·ªöNG D·∫™N DEPLOY - LOCAL V√Ä RAILWAY
================================================================================

## üéØ T√ìM T·∫ÆT GI·∫¢I PH√ÅP

ƒê√£ s·ª≠a l·ªói Network Error khi deploy Railway b·∫±ng c√°ch:
‚úÖ Th√™m ARG VITE_API_BASE_URL v√†o Dockerfile ƒë·ªÉ build time inject
‚úÖ T√°ch nginx config cho local (HTTP) v√† Railway (HTTPS)
‚úÖ S·ª≠ d·ª•ng bi·∫øn m√¥i tr∆∞·ªùng USE_HTTPS ƒë·ªÉ t·ª± ƒë·ªông ch·ªçn config ph√π h·ª£p

================================================================================
## üê≥ CH·∫†Y LOCAL V·ªöI DOCKER COMPOSE
================================================================================

### C√°ch 1: Ch·∫°y b√¨nh th∆∞·ªùng (Khuy·∫øn ngh·ªã)

```bash
docker-compose up -d --build
```

Frontend s·∫Ω:
- Build v·ªõi `VITE_API_BASE_URL=/api`
- Nginx d√πng HTTP config (nginx.conf.template.local)
- Proxy t·ªõi `http://api-gateway:3000`

**Truy c·∫≠p:**
- Customer Portal: http://localhost
- Restaurant Merchant: http://localhost:8080
- Admin Dashboard: http://localhost:8081
- API Gateway: http://localhost:3000


### C√°ch 2: Override bi·∫øn m√¥i tr∆∞·ªùng (N·∫øu c·∫ßn)

```bash
# Build v·ªõi custom API URL
docker-compose build --build-arg VITE_API_BASE_URL=http://localhost:3000/api frontend

# Sau ƒë√≥ ch·∫°y
docker-compose up -d
```

### Ki·ªÉm tra logs:

```bash
# Xem logs frontend
docker logs frontend

# T√¨m d√≤ng:
# "Using HTTP config for local..."
# "=== Nginx Config ==="

# Ki·ªÉm tra nginx ƒë√£ config ƒë√∫ng
docker exec frontend cat /etc/nginx/conf.d/default.conf
```

### Debug:

```bash
# Test API t·ª´ frontend container
docker exec frontend sh -c "wget -O- http://api-gateway:3000/api/products"

# Test t·ª´ host machine
curl http://localhost/api/products
```

================================================================================
## üöÄ DEPLOY L√äN RAILWAY
================================================================================

### B∆∞·ªõc 1: C·∫•u h√¨nh Environment Variables

#### A. Service: cnpm-fooddelivery (Frontend)

**Variables c·∫ßn set:**
```
USE_HTTPS=true
API_GATEWAY_HOST=<api-gateway-domain>.up.railway.app
```

**C√°ch l·∫•y API_GATEWAY_HOST:**
1. V√†o Railway Dashboard
2. Click service `api-gateway`
3. Tab Settings ‚Üí Domain
4. Copy domain (VD: `api-gateway-production-abc.up.railway.app`)
5. Paste v√†o `API_GATEWAY_HOST` (KH√îNG c√≥ https://, KH√îNG c√≥ /)

**V√≠ d·ª•:**
```
USE_HTTPS=true
API_GATEWAY_HOST=api-gateway-service-production-04a1.up.railway.app
```

#### B. Service: api-gateway

**Ki·ªÉm tra c√≥ ƒë·ªß:**
```
PORT=3000
USER_SERVICE_URL=http://user-service.railway.internal:1000
ORDER_SERVICE_URL=http://order-service.railway.internal:2000
PAYMENT_SERVICE_URL=http://payment-service.railway.internal:4000
PRODUCT_SERVICE_URL=http://product-service.railway.internal:3004
RESTAURANT_SERVICE_URL=http://restaurant-service.railway.internal:3005
CART_SERVICE_URL=http://cart-service.railway.internal:3006
LOCATION_SERVICE_URL=http://location-service.railway.internal:3007
JWT_SECRET=your-secret-key-here
```

**L∆ØU √ù:**
- Railway internal network: `<service-name>.railway.internal`
- Port ph·∫£i kh·ªõp v·ªõi service

#### C. C√°c Backend Services

M·ªói service c·∫ßn:
```
PORT=<port-number>
DATABASE_URL=<database-url>
KAFKA_BROKERS=<kafka-url>  # N·∫øu d√πng
```

### B∆∞·ªõc 2: Push Code

```bash
git add .
git commit -m "Fix: Network error - Support both local and Railway deployment"
git push
```

Railway s·∫Ω t·ª± ƒë·ªông:
1. Detect thay ƒë·ªïi
2. Build l·∫°i images
3. Deploy services m·ªõi

### B∆∞·ªõc 3: Ki·ªÉm tra Deploy

#### 3.1 Xem Logs Frontend

Railway Dashboard ‚Üí cnpm-fooddelivery ‚Üí Deployments ‚Üí View Logs

T√¨m c√°c d√≤ng sau (ph·∫£i th·∫•y ƒë·∫ßy ƒë·ªß):
```
=========================================
Starting Nginx Configuration...
=========================================
Environment Variables:
  API_GATEWAY_HOST: <domain-api-gateway>
  USE_HTTPS: true

Generating nginx configuration...
Configuring for RAILWAY (HTTPS)...

=========================================
Generated Nginx Configuration:
=========================================
...
proxy_pass https://<domain-api-gateway>/api/;
...
=========================================

Testing nginx configuration...
nginx: the configuration file /etc/nginx/nginx.conf syntax is ok
nginx: configuration file /etc/nginx/nginx.conf test is successful
Starting nginx...
```

**N·∫øu KH√îNG th·∫•y output n√†y** ‚Üí Container fail, xem error logs

#### 3.2 Test API Gateway

```bash
curl https://<api-gateway-url>/api/products
```

Ph·∫£i tr·∫£ v·ªÅ JSON data, KH√îNG l·ªói CORS ho·∫∑c 404

#### 3.3 Test Frontend

1. M·ªü `https://<frontend-url>`
2. DevTools ‚Üí Console
3. Xem log: `üîß API_BASE_URL: /api`
4. DevTools ‚Üí Network
5. Click v√†o request `/api/products`
6. Ki·ªÉm tra:
   - Status: 200 OK
   - Response: JSON data
   - Headers: CORS headers c√≥ m·∫∑t

================================================================================
## üêõ TROUBLESHOOTING
================================================================================

### L·ªói 1: "Network Error" tr√™n Railway

**Nguy√™n nh√¢n:** Nginx kh√¥ng k·∫øt n·ªëi ƒë∆∞·ª£c API Gateway

**Gi·∫£i ph√°p:**
1. Ki·ªÉm tra `API_GATEWAY_HOST` ƒë√£ set ƒë√∫ng ch∆∞a
2. Ki·ªÉm tra `USE_HTTPS=true` ƒë√£ set ch∆∞a
3. Xem logs nginx config c√≥ d√πng HTTPS kh√¥ng

```bash
# Railway Shell
cat /etc/nginx/conf.d/default.conf | grep proxy_pass
# Ph·∫£i th·∫•y: https://...
```

### L·ªói 2: "undefined" trong API URL

**Nguy√™n nh√¢n:** VITE_API_BASE_URL kh√¥ng ƒë∆∞·ª£c inject v√†o build

**Gi·∫£i ph√°p:**
1. Ki·ªÉm tra Dockerfile c√≥ ARG v√† ENV kh√¥ng
2. Rebuild image:
```bash
# Railway s·∫Ω t·ª± rebuild khi redeploy
# Ho·∫∑c Manual Deploy t·ª´ dashboard
```

### L·ªói 3: Local kh√¥ng ho·∫°t ƒë·ªông sau khi s·ª≠a

**Nguy√™n nh√¢n:** USE_HTTPS kh√¥ng ƒë∆∞·ª£c set ho·∫∑c set sai

**Gi·∫£i ph√°p:**
```bash
# Ki·ªÉm tra docker-compose.yml
# frontend service ph·∫£i c√≥:
# environment:
#   - USE_HTTPS=false

# Rebuild
docker-compose down
docker-compose up -d --build
```

### L·ªói 4: CORS Error

**Nguy√™n nh√¢n:** Domain frontend ch∆∞a c√≥ trong allowedOrigins

**Gi·∫£i ph√°p:**
S·ª≠a `backend/services/api-gateway/src/server.ts`:

```typescript
const allowedOrigins = [
    "http://localhost:5173",
    "http://localhost:8080",
    "http://localhost:8081",
    "http://localhost",
    "https://sgucnpmfoodfast-production.up.railway.app",
    "https://<new-domain>.up.railway.app"  // Th√™m d√≤ng n√†y
];
```

Commit v√† push l·∫°i.

### L·ªói 5: 502 Bad Gateway tr√™n Railway

**Nguy√™n nh√¢n:**
- API Gateway ch∆∞a s·∫µn s√†ng
- Service URL sai

**Gi·∫£i ph√°p:**
1. Ki·ªÉm tra API Gateway logs c√≥ error kh√¥ng
2. Ki·ªÉm tra c√°c backend service ƒë√£ ready ch∆∞a
3. Test API Gateway tr·ª±c ti·∫øp
4. ƒê·ª£i 2-3 ph√∫t ƒë·ªÉ Railway kh·ªüi ƒë·ªông ƒë·ªß services

================================================================================
## üìã CHECKLIST TR∆Ø·ªöC KHI DEPLOY
================================================================================

### Local Testing:
- [ ] `docker-compose up -d --build` ch·∫°y th√†nh c√¥ng
- [ ] http://localhost m·ªü ƒë∆∞·ª£c
- [ ] Console kh√¥ng c√≥ l·ªói "Network Error"
- [ ] Products load ƒë∆∞·ª£c t·ª´ API
- [ ] Cart, Order, Payment ho·∫°t ƒë·ªông

### Railway Deploy:
- [ ] API_GATEWAY_HOST ƒë√£ set ƒë√∫ng domain
- [ ] USE_HTTPS=true ƒë√£ set
- [ ] T·∫•t c·∫£ backend services ƒë√£ c√≥ env vars
- [ ] Code ƒë√£ commit v√† push
- [ ] Railway build th√†nh c√¥ng
- [ ] Logs kh√¥ng c√≥ error

### Post-Deploy:
- [ ] Frontend URL m·ªü ƒë∆∞·ª£c
- [ ] Console log API_BASE_URL = '/api'
- [ ] Network tab th·∫•y request ƒë·∫øn ƒë√∫ng URL
- [ ] Data load th√†nh c√¥ng
- [ ] Kh√¥ng c√≥ CORS error

================================================================================
## üîÑ SO S√ÅNH LOCAL VS RAILWAY
================================================================================

| Aspect              | Local Docker          | Railway                    |
|---------------------|-----------------------|----------------------------|
| VITE_API_BASE_URL   | /api                  | /api                       |
| USE_HTTPS           | false                 | true                       |
| Nginx Config        | .local (HTTP)         | .railway (HTTPS)           |
| API_GATEWAY_HOST    | api-gateway:3000      | xxx.up.railway.app         |
| Proxy Pass          | http://api-gw:3000    | https://xxx.railway.app    |
| CORS Origin         | http://localhost      | https://xxx.railway.app    |
| Network             | Docker bridge         | Railway internal           |

================================================================================
## üí° TIPS
================================================================================

1. **Railway m·∫•t 1-2 ph√∫t ƒë·ªÉ apply env vars** ‚Üí ƒê·ª£i r·ªìi m·ªõi test

2. **M·ªói l·∫ßn s·ª≠a env vars ph·∫£i redeploy** ‚Üí V√†o Settings ‚Üí Redeploy

3. **Railway logs real-time** ‚Üí M·ªü logs khi deploy ƒë·ªÉ debug ngay

4. **Test API Gateway tr∆∞·ªõc** ‚Üí ƒê·∫£m b·∫£o backend OK tr∆∞·ªõc khi test frontend

5. **D√πng curl ƒë·ªÉ test** ‚Üí Nhanh h∆°n m·ªü browser

6. **Railway c√≥ sleep mode** ‚Üí Service c√≥ th·ªÉ ng·ªß sau v√†i ph√∫t kh√¥ng d√πng

7. **Check Railway status page** ‚Üí ƒê√¥i khi Railway c√≥ s·ª± c·ªë

================================================================================

