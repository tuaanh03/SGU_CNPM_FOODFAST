â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ”´ VNPAY IPN KHÃ”NG HOáº T Äá»˜NG - ÄÃƒ Sá»¬A XONG
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

## âŒ Váº¤N Äá»€ Báº N Gáº¶P

**Triá»‡u chá»©ng:**
- VNPay thanh toÃ¡n thÃ nh cÃ´ng
- User Ä‘Æ°á»£c redirect vá» frontend OK
- âŒ NhÆ°ng Order status KHÃ”NG Ä‘Æ°á»£c cáº­p nháº­t
- âŒ VNPay IPN callback KHÃ”NG hoáº¡t Ä‘á»™ng

**URL Ä‘Ã£ config trÃªn VNPay Sandbox:**
```
IPN URL: https://api-gateway-service-production-04a1.up.railway.app/api/payments/vnpay_ipn
```

**Váº¥n Ä‘á» thá»±c táº¿:**
â†’ VNPay gá»i IPN nhÆ°ng server KHÃ”NG NHáº¬N Ä‘Æ°á»£c hoáº·c bá»‹ cháº·n!

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
## ğŸ› NGUYÃŠN NHÃ‚N Gá»C Rá»„
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

### 1. âŒ ROUTE KHÃ”NG Tá»’N Táº I

**API Gateway cÅ©:**
```typescript
// âŒ KHÃ”NG CÃ“ route /api/payments/vnpay_ipn
server.use("/vnpay_return", paymentServiceProxy);  // âœ… OK
server.use("/api/payment", authenticateToken, paymentServiceProxy);  // âŒ SAI!
```

â†’ Khi VNPay gá»i `/api/payments/vnpay_ipn` â†’ **404 Not Found**

### 2. âŒ Bá»Š CHáº¶N Bá»I AUTHENTICATION

**Váº¥n Ä‘á»:**
- Route `/api/payment` cÃ³ middleware `authenticateToken`
- VNPay server gá»i IPN **KHÃ”NG CÃ“ JWT TOKEN**
- â†’ Bá»‹ cháº·n vá»›i **401 Unauthorized**

**Táº¡i sao Ä‘Ã¢y lÃ  váº¥n Ä‘á»:**
```
VNPay Server (IPN)
   â†“ Gá»i khÃ´ng cÃ³ Authorization header
   â†“ GET https://...up.railway.app/api/payments/vnpay_ipn?vnp_xxx=...
   â†“
API Gateway
   â†“ authenticateToken middleware
   â†“ âŒ KhÃ´ng cÃ³ JWT token
   â†“
âŒ 401 Unauthorized
```

### 3. ğŸ”’ Báº¢N CHáº¤T VNPay IPN

**VNPay IPN lÃ  gÃ¬:**
- **Server-to-server callback** tá»« VNPay Ä‘áº¿n backend
- **KhÃ´ng pháº£i** user request (khÃ´ng cÃ³ JWT token)
- **Pháº£i** lÃ  public endpoint (khÃ´ng cáº§n authentication)
- **Báº£o máº­t** báº±ng signature verification (vnp_SecureHash)

**Flow Ä‘Ãºng:**
```
User thanh toÃ¡n trÃªn VNPay
   â†“
VNPay xá»­ lÃ½ thanh toÃ¡n
   â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  VNPay Return   â”‚   VNPay IPN     â”‚
â”‚  (User redirect)â”‚  (Server callback)â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
   â†“                    â†“
Frontend           Backend (Public endpoint)
   â†“                    â†“
Show result        Update Order Status
```

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
## âœ… ÄÃƒ Sá»¬A
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

### 1. Sá»­a API Gateway Routing

**File: `backend/services/api-gateway/src/server.ts`**

```typescript
// ==================== PAYMENT SERVICE ROUTES ====================

// VNPay callback routes - KHÃ”NG Cáº¦N AUTHENTICATION (VNPay server gá»i vÃ o)
// VNPay IPN (Instant Payment Notification) - Server-to-server callback
server.use("/api/payments/vnpay_ipn", paymentServiceProxy);

// VNPay Return URL - User redirect tá»« VNPay vá»
server.use("/vnpay_return", paymentServiceProxy);

// Payment service API routes - Cáº¦N AUTHENTICATION (Frontend gá»i)
server.use("/api/payment", authenticateToken, paymentServiceProxy);

console.log('âœ… Payment routes configured:');
console.log('  - /api/payments/vnpay_ipn â†’ Payment Service (NO AUTH - VNPay callback)');
console.log('  - /vnpay_return â†’ Payment Service (NO AUTH - User redirect)');
console.log('  - /api/payment/* â†’ Payment Service (WITH AUTH)');
```

**Äiá»ƒm má»‘t quan trá»ng:**
- âœ… `/api/payments/vnpay_ipn` â†’ **KHÃ”NG cÃ³** `authenticateToken`
- âœ… `/vnpay_return` â†’ **KHÃ”NG cÃ³** `authenticateToken`
- âœ… `/api/payment/*` â†’ **CÃ“** `authenticateToken` (cho frontend calls)

### 2. Sá»­a Payment Service Routing

**File: `backend/services/payment-service/src/server.ts`**

```typescript
// Routes
// VNPay callbacks Ä‘Æ°á»£c gá»i trá»±c tiáº¿p khÃ´ng qua /api prefix
server.use("/", paymentRoute);

// API endpoints Ä‘Æ°á»£c gá»i qua /api/payment prefix tá»« Gateway
server.use("/payment", paymentRoute);

// VNPay IPN Ä‘Æ°á»£c gá»i qua /api/payments/vnpay_ipn tá»« Gateway
// Gateway sáº½ remove /api vÃ  gá»­i /payments/vnpay_ipn Ä‘áº¿n Ä‘Ã¢y
server.use("/payments", paymentRoute);

console.log('âœ… Payment Service routes configured:');
console.log('  - / â†’ Direct VNPay callbacks');
console.log('  - /payment â†’ API Gateway routes (WITH AUTH)');
console.log('  - /payments â†’ API Gateway VNPay IPN route (NO AUTH)');
```

### 3. Security - Váº«n An ToÃ n!

**DÃ¹ khÃ´ng cÃ³ JWT authentication, IPN váº«n báº£o máº­t báº±ng:**

```typescript
// File: payment-service/src/controllers/payment.ts
export const vnpayIPN = async (req: Request, res: Response) => {
    // âœ… BÆ°á»›c 1 & 2: Verify signature tá»« VNPay
    const verify = vnpay.verifyIpnCall(req.query as any);

    if (!verify.isVerified) {
        // âŒ Signature khÃ´ng Ä‘Ãºng â†’ Reject
        console.error("Invalid signature in VNPay IPN");
        return res.json(IpnFailChecksum);
    }

    console.log("âœ“ VNPay IPN signature verified successfully");

    // âœ… Chá»‰ xá»­ lÃ½ khi signature ÄÃšNG
    // VNPay kÃ½ báº±ng VNPAY_HASH_SECRET (chá»‰ VNPay vÃ  server biáº¿t)
    // â†’ KhÃ´ng ai khÃ¡c cÃ³ thá»ƒ giáº£ máº¡o IPN call
}
```

**Táº¡i sao an toÃ n:**
- âœ… VNPay kÃ½ má»—i request báº±ng `vnp_SecureHash`
- âœ… Hash Ä‘Æ°á»£c táº¡o tá»« `VNPAY_HASH_SECRET` (chá»‰ VNPay vÃ  báº¡n biáº¿t)
- âœ… Server verify signature trÆ°á»›c khi xá»­ lÃ½
- âœ… KhÃ´ng thá»ƒ giáº£ máº¡o IPN request

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
## ğŸš€ Cáº¤U HÃŒNH VNPAY SANDBOX
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

### BÆ¯á»šC 1: ÄÄƒng nháº­p VNPay Sandbox

URL: https://sandbox.vnpayment.vn/merchantv2/

### BÆ¯á»šC 2: Cáº¥u hÃ¬nh IPN URL

**VÃ o:** Cáº¥u hÃ¬nh â†’ ThÃ´ng tin cáº¥u hÃ¬nh â†’ IPN URL

**Cáº¥u hÃ¬nh:**
```
IPN URL: https://api-gateway-service-production-04a1.up.railway.app/api/payments/vnpay_ipn
```

âš ï¸ **LÆ¯U Ã QUAN TRá»ŒNG:**
- âœ… Pháº£i lÃ  URL **PUBLIC** (Railway public domain)
- âœ… Pháº£i lÃ  **HTTPS**
- âœ… KhÃ´ng cÃ³ `/` á»Ÿ cuá»‘i
- âœ… Path chÃ­nh xÃ¡c: `/api/payments/vnpay_ipn` (cÃ³ chá»¯ "s")
- âŒ KHÃ”NG dÃ¹ng domain ná»™i bá»™ `.railway.internal`
- âŒ KHÃ”NG dÃ¹ng localhost

### BÆ¯á»šC 3: LÆ°u thay Ä‘á»•i

Click **LÆ°u** trong VNPay Merchant Portal

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
## ğŸ”§ Cáº¤U HÃŒNH BIáº¾N MÃ”I TRÆ¯á»œNG RAILWAY
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

### Payment Service trÃªn Railway:

```bash
# VNPay Configuration
VNPAY_TMN_CODE=<your_tmn_code>
VNPAY_HASH_SECRET=<your_hash_secret>
VNPAY_API_URL=https://sandbox.vnpayment.vn/paymentv2/vpcpay.html

# Return URL - User redirect sau khi thanh toÃ¡n
VNPAY_RETURN_URL=https://sgu-cnpm-foodfast.vercel.app/payment-result

# âŒ KHÃ”NG Cáº¦N config VNPAY_IPN_URL (VNPay config trÃªn portal)
# IPN URL Ä‘Æ°á»£c config trÃªn VNPay Merchant Portal, khÃ´ng pháº£i biáº¿n mÃ´i trÆ°á»ng

# Frontend URL cho redirect
FRONTEND_URL=https://sgu-cnpm-foodfast.vercel.app

# Database
DATABASE_URL=${{Postgres.DATABASE_URL}}

# Kafka
KAFKA_BROKERS=<cluster>.confluent.cloud:9092
KAFKA_USERNAME=<api_key>
KAFKA_PASSWORD=<api_secret>
KAFKA_SECURITY_PROTOCOL=SASL_SSL
KAFKA_SASL_MECHANISM=PLAIN

# Other
PORT=4000
NODE_ENV=production
```

**Giáº£i thÃ­ch:**
- âœ… `VNPAY_RETURN_URL`: Frontend URL Ä‘á»ƒ redirect user
- âŒ `VNPAY_IPN_URL`: **KHÃ”NG Cáº¦N** - Config trá»±c tiáº¿p trÃªn VNPay portal
- âœ… `FRONTEND_URL`: Fallback cho return URL

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
## ğŸ§ª KIá»‚M TRA VÃ€ DEBUG
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

### BÆ¯á»šC 1: Deploy vÃ  kiá»ƒm tra logs

**Sau khi deploy API Gateway vÃ  Payment Service:**

**API Gateway logs pháº£i tháº¥y:**
```
âœ… Payment routes configured:
  - /api/payments/vnpay_ipn â†’ Payment Service (NO AUTH - VNPay callback)
  - /vnpay_return â†’ Payment Service (NO AUTH - User redirect)
  - /api/payment/* â†’ Payment Service (WITH AUTH)
```

**Payment Service logs pháº£i tháº¥y:**
```
âœ… Payment Service routes configured:
  - / â†’ Direct VNPay callbacks
  - /payment â†’ API Gateway routes (WITH AUTH)
  - /payments â†’ API Gateway VNPay IPN route (NO AUTH)
```

### BÆ¯á»šC 2: Test thanh toÃ¡n

**1. Táº¡o Ä‘Æ¡n hÃ ng vÃ  thanh toÃ¡n:**
```
Frontend â†’ Create Order â†’ Get Payment URL â†’ Redirect to VNPay
```

**2. Thanh toÃ¡n trÃªn VNPay (Sandbox):**
```
Tháº» test: 9704198526191432198
TÃªn: NGUYEN VAN A
NgÃ y phÃ¡t hÃ nh: 07/15
MÃ£ OTP: 123456
```

**3. Kiá»ƒm tra logs Payment Service:**

**TRÆ¯á»šC (Lá»—i - KhÃ´ng nháº­n IPN):**
```
âŒ KhÃ´ng cÃ³ log nÃ o tá»« VNPay IPN
```

**SAU (ThÃ nh cÃ´ng):**
```
âœ… VNPay IPN received: { vnp_TxnRef: '...', vnp_Amount: '...', ... }
âœ… VNPay IPN signature verified successfully
âœ… Updated PaymentIntent xxx and PaymentAttempt to success
âœ… Published payment success event for order yyy
```

### BÆ¯á»šC 3: Verify Order Status

**Kiá»ƒm tra Order Ä‘Ã£ Ä‘Æ°á»£c cáº­p nháº­t:**
```bash
# API call
GET /api/order/{orderId}
Authorization: Bearer {token}

# Response
{
  "success": true,
  "data": {
    "id": "order_xxx",
    "status": "PAID",  // âœ… ÄÃ£ Ä‘Æ°á»£c cáº­p nháº­t tá»« PENDING_PAYMENT
    "totalPrice": 50000,
    ...
  }
}
```

### BÆ¯á»šC 4: Test trá»±c tiáº¿p IPN endpoint

**DÃ¹ng Postman hoáº·c curl (chá»‰ Ä‘á»ƒ test routing):**

```bash
curl -X GET "https://api-gateway-service-production-04a1.up.railway.app/api/payments/vnpay_ipn?vnp_TxnRef=test&vnp_Amount=5000000" -v
```

**Káº¿t quáº£ mong Ä‘á»£i:**
```
< HTTP/2 200
{
  "RspCode": "97",  // IpnFailChecksum - VÃ¬ signature khÃ´ng Ä‘Ãºng (expected)
  "Message": "Invalid Checksum"
}
```

**Äiá»u nÃ y chá»©ng tá»:**
- âœ… Route hoáº¡t Ä‘á»™ng (khÃ´ng 404)
- âœ… KhÃ´ng bá»‹ cháº·n authentication (khÃ´ng 401)
- âœ… Payment Service nháº­n Ä‘Æ°á»£c request
- âŒ Signature verification failed (Ä‘Ãºng nhÆ° mong Ä‘á»£i - test khÃ´ng cÃ³ signature Ä‘Ãºng)

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
## ğŸ”„ FLOW HOÃ€N CHá»ˆNH SAU KHI Sá»¬A
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”ï¿½ï¿½â”â”â”â”â”â”â”â”â”â”â”â”

### 1. User thanh toÃ¡n trÃªn VNPay

```
User â†’ VNPay Payment Page
     â†’ Nháº­p thÃ´ng tin tháº»
     â†’ Click "Thanh toÃ¡n"
```

### 2. VNPay xá»­ lÃ½ thanh toÃ¡n

```
VNPay Server
  â”œâ”€â†’ Kiá»ƒm tra tháº»
  â”œâ”€â†’ Xá»­ lÃ½ giao dá»‹ch
  â””â”€â†’ Thanh toÃ¡n thÃ nh cÃ´ng
```

### 3. VNPay gá»­i 2 callbacks

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    VNPay Callbacks                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚   Return URL         â”‚         IPN URL                   â”‚
â”‚   (User redirect)    â”‚    (Server notification)          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â†“                            â†“
    Frontend                    API Gateway
         â†“                            â†“
   Show result               /api/payments/vnpay_ipn
                                      â†“
                              Payment Service
                                      â†“
                              Verify signature
                                      â†“
                              Update Order Status
                                      â†“
                              Publish Kafka Event
                                      â†“
                              Order Service
                                      â†“
                            Update Order â†’ PAID
```

### 4. User tháº¥y káº¿t quáº£

```
Frontend â†’ /payment-result?status=success&orderId=xxx
        â†’ Hiá»ƒn thá»‹ "Thanh toÃ¡n thÃ nh cÃ´ng"
        â†’ Order status: PAID
```

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
## ğŸ³ DOCKER-COMPOSE (LOCAL) - KHÃ”NG áº¢NH HÆ¯á»NG
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

**Local development:**
- âœ… VNPay Return URL váº«n hoáº¡t Ä‘á»™ng
- âš ï¸ VNPay IPN sáº½ **KHÃ”NG hoáº¡t Ä‘á»™ng** local (VNPay khÃ´ng thá»ƒ gá»i localhost)
- âœ… DÃ¹ng **ngrok** Ä‘á»ƒ test IPN local (nhÆ° cÅ©)

**Ngrok setup (náº¿u cáº§n test IPN local):**
```bash
# Terminal 1: Run services
docker-compose up

# Terminal 2: Expose API Gateway
ngrok http 3000

# Láº¥y ngrok URL vÃ  config trÃªn VNPay sandbox
# IPN URL: https://xxxx.ngrok.io/api/payments/vnpay_ipn
```

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
## ğŸ“‹ CHECKLIST
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

### Railway Deployment:

â–¡ Deploy API Gateway vá»›i code má»›i
â–¡ Deploy Payment Service vá»›i code má»›i
â–¡ Kiá»ƒm tra logs: Payment routes configured
â–¡ Kiá»ƒm tra API Gateway logs: vnpay_ipn route exists
â–¡ Verify biáº¿n mÃ´i trÆ°á»ng Payment Service Ä‘áº§y Ä‘á»§

### VNPay Configuration:

â–¡ ÄÄƒng nháº­p VNPay Sandbox
â–¡ VÃ o Cáº¥u hÃ¬nh â†’ IPN URL
â–¡ Set: `https://api-gateway-service-production-04a1.up.railway.app/api/payments/vnpay_ipn`
â–¡ Click LÆ°u
â–¡ Verify URL Ä‘Ã£ Ä‘Æ°á»£c lÆ°u

### Testing:

â–¡ Táº¡o Ä‘Æ¡n hÃ ng má»›i
â–¡ Thanh toÃ¡n qua VNPay (sandbox)
â–¡ Kiá»ƒm tra Payment Service logs: IPN received
â–¡ Kiá»ƒm tra Payment Service logs: Signature verified
â–¡ Kiá»ƒm tra Payment Service logs: Order updated
â–¡ Verify Order status: PAID
â–¡ Verify frontend hiá»ƒn thá»‹ thÃ nh cÃ´ng

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
## â“ TROUBLESHOOTING
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

### Lá»—i: VNPay IPN váº«n khÃ´ng nháº­n Ä‘Æ°á»£c

**Kiá»ƒm tra:**
1. IPN URL trÃªn VNPay portal cÃ³ Ä‘Ãºng khÃ´ng?
2. API Gateway cÃ³ log "Payment routes configured" khÃ´ng?
3. Payment Service cÃ³ cháº¡y khÃ´ng? (health check)
4. Firewall Railway cÃ³ cháº·n khÃ´ng? (check Railway settings)

**Debug:**
```bash
# Test IPN endpoint trá»±c tiáº¿p
curl -X GET "https://api-gateway-service-production-04a1.up.railway.app/api/payments/vnpay_ipn?test=1" -v

# Káº¿t quáº£ mong Ä‘á»£i: 200 OK (khÃ´ng 404, khÃ´ng 401)
```

### Lá»—i: "Invalid signature"

**NguyÃªn nhÃ¢n:**
- `VNPAY_HASH_SECRET` sai
- Request parameters bá»‹ thay Ä‘á»•i trong quÃ¡ trÃ¬nh proxy

**Giáº£i phÃ¡p:**
- Verify `VNPAY_HASH_SECRET` trÃªn Railway
- Kiá»ƒm tra logs: VNPay IPN received parameters

### Lá»—i: Order status khÃ´ng cáº­p nháº­t

**NguyÃªn nhÃ¢n:**
- Kafka event khÃ´ng Ä‘Æ°á»£c publish
- Order Service khÃ´ng consume event

**Kiá»ƒm tra:**
- Payment Service logs: "Published payment success event"
- Order Service logs: "Received payment event"
- Kafka cluster connection

### Lá»—i: 404 Not Found

**NguyÃªn nhÃ¢n:**
- API Gateway chÆ°a deploy code má»›i
- Route config sai

**Giáº£i phÃ¡p:**
- Redeploy API Gateway
- Verify logs: "Payment routes configured"

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
## ğŸ¯ TÃ“M Táº®T
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

**Váº¥n Ä‘á» gá»‘c:**
- VNPay IPN bá»‹ cháº·n bá»Ÿi JWT authentication
- Route `/api/payments/vnpay_ipn` khÃ´ng tá»“n táº¡i

**Giáº£i phÃ¡p:**
- âœ… ThÃªm route `/api/payments/vnpay_ipn` KHÃ”NG cÃ³ authentication
- âœ… Váº«n báº£o máº­t báº±ng signature verification
- âœ… Payment Service routing há»— trá»£ path má»›i

**Cáº¥u hÃ¬nh VNPay:**
- IPN URL: `https://api-gateway-service-production-04a1.up.railway.app/api/payments/vnpay_ipn`
- Return URL: DÃ¹ng biáº¿n `VNPAY_RETURN_URL` (frontend URL)

**Files Ä‘Ã£ sá»­a:**
1. `backend/services/api-gateway/src/server.ts` âœ…
2. `backend/services/payment-service/src/server.ts` âœ…

**BÆ°á»›c tiáº¿p theo:**
1. Deploy API Gateway vÃ  Payment Service
2. Config IPN URL trÃªn VNPay Sandbox
3. Test thanh toÃ¡n
4. Verify Order status Ä‘Æ°á»£c cáº­p nháº­t

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

