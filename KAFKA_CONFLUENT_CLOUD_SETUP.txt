â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸš€ Cáº¤U HÃŒNH KAFKA CHO CONFLUENT CLOUD
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

## ğŸ“ BÆ¯á»šC 1: Táº O TOPICS TRÃŠN CONFLUENT CLOUD

VÃ o: https://confluent.cloud/
â†’ Environments â†’ Clusters â†’ Topics â†’ Add topic

Táº¡o 7 topics sau:

â–¡ order.create (3 partitions, 7 days retention)
â–¡ order.expired (3 partitions, 7 days retention)
â–¡ order.retry.payment (3 partitions, 7 days retention)
â–¡ order.confirmed (3 partitions, 7 days retention)
â–¡ payment.event (3 partitions, 7 days retention)
â–¡ product.sync (3 partitions, 7 days retention)
â–¡ inventory.reserve.result (3 partitions, 7 days retention)

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
## ğŸ”‘ BÆ¯á»šC 2: Táº O API KEY & SECRET

VÃ o: Cluster Settings â†’ API Keys â†’ Add Key

Chá»n: Global access (hoáº·c topic-specific náº¿u cáº§n báº£o máº­t cao)

LÆ°u láº¡i:
- API Key: xxxxxxxxxxxx
- API Secret: yyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyy

âš ï¸ QUAN TRá»ŒNG: LÆ°u Secret ngay, khÃ´ng thá»ƒ xem láº¡i!

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
## ğŸ“¡ BÆ¯á»šC 3: Láº¤Y BOOTSTRAP SERVERS

VÃ o: Cluster Settings â†’ Cluster Overview

Láº¥y Bootstrap Server URL:
VÃ­ dá»¥: pkc-xxxxx.us-east-1.aws.confluent.cloud:9092

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
## âš™ï¸ BÆ¯á»šC 4: Cáº¤U HÃŒNH BIáº¾N MÃ”I TRÆ¯á»œNG
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

### **DOCKER-COMPOSE (Local Development)**

Giá»¯ nguyÃªn kafka local:
```yaml
KAFKA_BROKERS=kafka:9092
```

Hoáº·c test vá»›i Confluent Cloud:
```yaml
KAFKA_BROKERS=pkc-xxxxx.us-east-1.aws.confluent.cloud:9092
KAFKA_USERNAME=<API_KEY>
KAFKA_PASSWORD=<API_SECRET>
KAFKA_SECURITY_PROTOCOL=SASL_SSL
KAFKA_SASL_MECHANISM=PLAIN
```

### **RAILWAY (Production)**

Set biáº¿n mÃ´i trÆ°á»ng cho Má»ŒI service:

**Order Service:**
```
KAFKA_BROKERS=pkc-xxxxx.us-east-1.aws.confluent.cloud:9092
KAFKA_USERNAME=<API_KEY>
KAFKA_PASSWORD=<API_SECRET>
KAFKA_SECURITY_PROTOCOL=SASL_SSL
KAFKA_SASL_MECHANISM=PLAIN
```

**Payment Service:**
```
KAFKA_BROKERS=pkc-xxxxx.us-east-1.aws.confluent.cloud:9092
KAFKA_USERNAME=<API_KEY>
KAFKA_PASSWORD=<API_SECRET>
KAFKA_SECURITY_PROTOCOL=SASL_SSL
KAFKA_SASL_MECHANISM=PLAIN
```

**Product Service:**
```
KAFKA_BROKERS=pkc-xxxxx.us-east-1.aws.confluent.cloud:9092
KAFKA_USERNAME=<API_KEY>
KAFKA_PASSWORD=<API_SECRET>
KAFKA_SECURITY_PROTOCOL=SASL_SSL
KAFKA_SASL_MECHANISM=PLAIN
```

**Notification Service:**
```
KAFKA_BROKERS=pkc-xxxxx.us-east-1.aws.confluent.cloud:9092
KAFKA_USERNAME=<API_KEY>
KAFKA_PASSWORD=<API_SECRET>
KAFKA_SECURITY_PROTOCOL=SASL_SSL
KAFKA_SASL_MECHANISM=PLAIN
```

**Restaurant Service:**
```
KAFKA_BROKERS=pkc-xxxxx.us-east-1.aws.confluent.cloud:9092
KAFKA_USERNAME=<API_KEY>
KAFKA_PASSWORD=<API_SECRET>
KAFKA_SECURITY_PROTOCOL=SASL_SSL
KAFKA_SASL_MECHANISM=PLAIN
```

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
## ğŸ”§ BÆ¯á»šC 5: Cáº¬P NHáº¬T CODE KAFKA.TS
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

**Hiá»‡n táº¡i code Ä‘ang dÃ¹ng:**
```typescript
const kafka = new Kafka({
  clientId: "payment-service",
  brokers: ["kafka:9092"],
  retry: { ... }
});
```

**Cáº§n sá»­a thÃ nh:**
```typescript
const kafkaBrokers = process.env.KAFKA_BROKERS?.split(',') || ['kafka:9092'];
const kafkaUsername = process.env.KAFKA_USERNAME;
const kafkaPassword = process.env.KAFKA_PASSWORD;

const kafka = new Kafka({
  clientId: "payment-service",
  brokers: kafkaBrokers,
  ssl: process.env.KAFKA_SECURITY_PROTOCOL === 'SASL_SSL',
  sasl: kafkaUsername && kafkaPassword ? {
    mechanism: 'plain',
    username: kafkaUsername,
    password: kafkaPassword
  } : undefined,
  retry: {
    initialRetryTime: 100,
    maxRetryTime: 30000,
    retries: 10,
    factor: 0.2,
  },
});
```

âš ï¸ Cáº¦N Sá»¬A TRONG 5 FILES:
1. backend/services/order-service/src/utils/kafka.ts
2. backend/services/payment-service/src/utils/kafka.ts
3. backend/services/product-service/src/utils/kafka.ts
4. backend/services/notification-service/src/utils/kafka.ts
5. backend/services/restaurant-service/src/utils/kafka.ts

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
## âœ… BÆ¯á»šC 6: TEST & VERIFY
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

### Test local vá»›i Confluent Cloud:

1. Set biáº¿n mÃ´i trÆ°á»ng:
```bash
export KAFKA_BROKERS=pkc-xxxxx.us-east-1.aws.confluent.cloud:9092
export KAFKA_USERNAME=<API_KEY>
export KAFKA_PASSWORD=<API_SECRET>
export KAFKA_SECURITY_PROTOCOL=SASL_SSL
export KAFKA_SASL_MECHANISM=PLAIN
```

2. Cháº¡y má»™t service:
```bash
cd backend/services/payment-service
npm run dev
```

3. Kiá»ƒm tra log:
- "âœ… Kafka producer connected"
- "âœ… Kafka consumer connected"

### Verify trÃªn Confluent Cloud:

VÃ o: Topics â†’ Chá»n topic â†’ Messages

Kiá»ƒm tra:
- CÃ³ message má»›i xuáº¥t hiá»‡n
- Consumer groups hoáº¡t Ä‘á»™ng
- Lag = 0 (consumer Ä‘Ã£ xá»­ lÃ½ háº¿t message)

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
## ğŸ’° CHI PHÃ CONFLUENT CLOUD
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

**Free Tier:**
- 1 Basic cluster
- Unlimited topics
- $400 credit (4 thÃ¡ng sá»­ dá»¥ng)

**Basic Cluster:**
- ~$1-2/day vá»›i traffic tháº¥p
- PhÃ¹ há»£p cho development/staging

**LÆ°u Ã½:**
- Set retention 7 days Ä‘á»ƒ tiáº¿t kiá»‡m storage
- Monitor usage Ä‘á»ƒ trÃ¡nh vÆ°á»£t free tier
- Delete topics khÃ´ng dÃ¹ng

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
## ğŸ› TROUBLESHOOTING
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

### Lá»—i: "Authentication failed"
â†’ Kiá»ƒm tra API Key & Secret Ä‘Ãºng
â†’ Kiá»ƒm tra KAFKA_USERNAME vÃ  KAFKA_PASSWORD

### Lá»—i: "Connection timeout"
â†’ Kiá»ƒm tra KAFKA_BROKERS URL Ä‘Ãºng
â†’ Kiá»ƒm tra firewall/network (Railway cáº§n allow outbound)

### Lá»—i: "Topic not found"
â†’ Táº¡o topic trÃªn Confluent Cloud
â†’ Kiá»ƒm tra tÃªn topic khá»›p vá»›i code

### Lá»—i: "SSL handshake failed"
â†’ Set KAFKA_SECURITY_PROTOCOL=SASL_SSL
â†’ Kiá»ƒm tra ssl: true trong config

### Consumer khÃ´ng nháº­n message:
â†’ Kiá»ƒm tra consumer group name
â†’ Kiá»ƒm tra topic subscription
â†’ Reset offset náº¿u cáº§n: consumer.seek()

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
## ğŸ“š TÃ€I LIá»†U THAM KHáº¢O
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

Confluent Cloud Docs:
https://docs.confluent.io/cloud/current/overview.html

KafkaJS vá»›i Confluent Cloud:
https://github.com/tulios/kafkajs#sasl

Railway Environment Variables:
https://docs.railway.app/develop/variables

