â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸš€ HÆ¯á»šNG DáºªN NHANH - Sá»¬A VNPAY IPN
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

## âŒ Váº¤N Äá»€

VNPay IPN khÃ´ng hoáº¡t Ä‘á»™ng â†’ Order status khÃ´ng cáº­p nháº­t sau thanh toÃ¡n

**NguyÃªn nhÃ¢n:**
- Route `/api/payments/vnpay_ipn` KHÃ”NG tá»“n táº¡i
- VNPay IPN bá»‹ cháº·n bá»Ÿi JWT authentication
- VNPay gá»i IPN khÃ´ng cÃ³ JWT token â†’ 401 Unauthorized

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

## âœ… ÄÃƒ Sá»¬A

**Files:**
1. `backend/services/api-gateway/src/server.ts`
2. `backend/services/payment-service/src/server.ts`

**Thay Ä‘á»•i:**
- âœ… ThÃªm route `/api/payments/vnpay_ipn` **KHÃ”NG CÃ“** authentication
- âœ… VNPay cÃ³ thá»ƒ gá»i IPN mÃ  khÃ´ng bá»‹ cháº·n
- âœ… Váº«n báº£o máº­t báº±ng signature verification

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

## ğŸš€ Cáº¤U HÃŒNH

### 1. Deploy Railway

```bash
# Deploy API Gateway vÃ  Payment Service
# Kiá»ƒm tra logs pháº£i tháº¥y:
âœ… Payment routes configured:
  - /api/payments/vnpay_ipn â†’ Payment Service (NO AUTH - VNPay callback)
```

### 2. Config VNPay Sandbox

**URL:** https://sandbox.vnpayment.vn/merchantv2/

**VÃ o:** Cáº¥u hÃ¬nh â†’ ThÃ´ng tin cáº¥u hÃ¬nh â†’ IPN URL

**Set:**
```
https://api-gateway-service-production-04a1.up.railway.app/api/payments/vnpay_ipn
```

âš ï¸ **LÆ°u Ã½:**
- Pháº£i lÃ  HTTPS
- KhÃ´ng cÃ³ `/` á»Ÿ cuá»‘i
- Path: `/api/payments/vnpay_ipn` (cÃ³ chá»¯ "s")

### 3. Biáº¿n mÃ´i trÆ°á»ng Payment Service

```bash
VNPAY_TMN_CODE=<your_code>
VNPAY_HASH_SECRET=<your_secret>
VNPAY_API_URL=https://sandbox.vnpayment.vn/paymentv2/vpcpay.html
VNPAY_RETURN_URL=https://sgu-cnpm-foodfast.vercel.app/payment-result
FRONTEND_URL=https://sgu-cnpm-foodfast.vercel.app
```

âŒ **KHÃ”NG Cáº¦N** `VNPAY_IPN_URL` - Config trÃªn VNPay portal

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

## ğŸ§ª TEST

### 1. Thanh toÃ¡n VNPay (Sandbox)

```
Tháº»: 9704198526191432198
TÃªn: NGUYEN VAN A
NgÃ y: 07/15
OTP: 123456
```

### 2. Kiá»ƒm tra logs Payment Service

**ThÃ nh cÃ´ng khi tháº¥y:**
```
âœ… VNPay IPN received: { vnp_TxnRef: '...', ... }
âœ… VNPay IPN signature verified successfully
âœ… Updated PaymentIntent xxx to success
âœ… Published payment success event for order yyy
```

### 3. Verify Order status

```
GET /api/order/{orderId}

Response:
{
  "status": "PAID"  âœ…
}
```

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

## ğŸ› TROUBLESHOOTING

**VNPay IPN váº«n khÃ´ng nháº­n:**
```bash
# Test route
curl "https://api-gateway-service-production-04a1.up.railway.app/api/payments/vnpay_ipn?test=1" -v

# Káº¿t quáº£ mong Ä‘á»£i: 200 OK (khÃ´ng 404, khÃ´ng 401)
```

**Kiá»ƒm tra:**
- [ ] API Gateway Ä‘Ã£ deploy code má»›i?
- [ ] IPN URL trÃªn VNPay cÃ³ Ä‘Ãºng?
- [ ] Payment Service cÃ³ cháº¡y?
- [ ] Logs cÃ³ "Payment routes configured"?

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

## ğŸ“‹ CHECKLIST

â–¡ Deploy API Gateway vÃ  Payment Service
â–¡ Kiá»ƒm tra logs: "Payment routes configured"
â–¡ Config IPN URL trÃªn VNPay Sandbox
â–¡ Test thanh toÃ¡n VNPay
â–¡ Kiá»ƒm tra logs: "VNPay IPN received"
â–¡ Kiá»ƒm tra logs: "Signature verified"
â–¡ Verify Order status: PAID

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

Chi tiáº¿t Ä‘áº§y Ä‘á»§: Xem file VNPAY_IPN_FIX.txt

