â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ”§ Cáº¤U HÃŒNH VNPAY RETURN URL & IPN URL
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

## ğŸ“‹ TÃ“M Táº®T

**RETURN URL**: User redirect sau khi thanh toÃ¡n â†’ Frontend
**IPN URL**: Server-to-server notification â†’ API Gateway â†’ Payment Service

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
## 1ï¸âƒ£ DOCKER-COMPOSE (Local Development)
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

### **BÆ°á»›c 1: Cháº¡y ngrok**
```bash
ngrok http 3000
```

Láº¥y URL ngrok (vÃ­ dá»¥: https://abc-xyz.ngrok-free.dev)

### **BÆ°á»›c 2: Cáº­p nháº­t .env trong payment-service**
```env
VNPAY_RETURN_URL=https://abc-xyz.ngrok-free.dev/payment-result
VNPAY_IPN_URL=https://abc-xyz.ngrok-free.dev/api/payments/vnpay_ipn
FRONTEND_URL=http://localhost:3000
```

### **BÆ°á»›c 3: Cáº¥u hÃ¬nh VNPay Sandbox Portal**
- VÃ o: https://sandbox.vnpayment.vn/merchantv2/
- Login vá»›i tÃ i khoáº£n merchant
- VÃ o: **Cáº¥u hÃ¬nh** â†’ **URL IPN**
- Nháº­p: `https://abc-xyz.ngrok-free.dev/api/payments/vnpay_ipn`
- LÆ°u láº¡i

### **Luá»“ng hoáº¡t Ä‘á»™ng:**
```
User thanh toÃ¡n VNPay
  â†“
VNPay redirect â†’ https://abc-xyz.ngrok-free.dev/payment-result
  â†“
Frontend hiá»ƒn thá»‹ káº¿t quáº£

VNPay gá»­i IPN â†’ https://abc-xyz.ngrok-free.dev/api/payments/vnpay_ipn
  â†“
Nginx proxy â†’ http://api-gateway:3000/api/payments/vnpay_ipn
  â†“
API Gateway proxy â†’ http://payment-service:4000/vnpay_ipn
  â†“
Payment service xá»­ lÃ½ â†’ Update DB â†’ Kafka event
```

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
## 2ï¸âƒ£ RAILWAY/VERCEL PRODUCTION
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

### **Frontend (Vercel)**
Domain: `https://sgu-cnpm-foodfast.vercel.app`

### **API Gateway (Railway)**
Domain: `https://api-gateway-service-production-04a1.up.railway.app`

### **Cáº¥u hÃ¬nh biáº¿n mÃ´i trÆ°á»ng trÃªn Railway (Payment Service)**
```env
VNPAY_RETURN_URL=https://sgu-cnpm-foodfast.vercel.app/payment-result
VNPAY_IPN_URL=https://api-gateway-service-production-04a1.up.railway.app/api/payments/vnpay_ipn
FRONTEND_URL=https://sgu-cnpm-foodfast.vercel.app
```

### **âš ï¸ QUAN TRá»ŒNG: Cáº¥u hÃ¬nh VNPay Sandbox Portal**
- VÃ o: https://sandbox.vnpayment.vn/merchantv2/
- Login vá»›i tÃ i khoáº£n merchant
- VÃ o: **Cáº¥u hÃ¬nh** â†’ **URL IPN**
- Nháº­p: `https://api-gateway-service-production-04a1.up.railway.app/api/payments/vnpay_ipn`
- **LÆ°u láº¡i**

### **Luá»“ng hoáº¡t Ä‘á»™ng:**
```
User thanh toÃ¡n VNPay
  â†“
VNPay redirect â†’ https://sgu-cnpm-foodfast.vercel.app/payment-result
  â†“
Frontend Vercel hiá»ƒn thá»‹ káº¿t quáº£

VNPay gá»­i IPN â†’ https://api-gateway-service-production-04a1.up.railway.app/api/payments/vnpay_ipn
  â†“
API Gateway â†’ http://payment-service.railway.internal:4000/vnpay_ipn
  â†“
Payment service xá»­ lÃ½ â†’ Update DB â†’ Kafka event
```

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
## 3ï¸âƒ£ CÃ‚U Há»I THÆ¯á»œNG Gáº¶P
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

### **Q: IPN URL cÃ³ cáº§n cáº¥u hÃ¬nh trong VNPay Portal khÃ´ng?**
A: **CÃ“**, báº¯t buá»™c pháº£i config trong VNPay Merchant Portal.
   ThÆ° viá»‡n vnpay khÃ´ng cho phÃ©p truyá»n IPN URL qua API.

### **Q: Return URL cÃ³ cáº§n config trong Portal khÃ´ng?**
A: **KHÃ”NG**, Return URL Ä‘Æ°á»£c truyá»n qua API khi táº¡o payment URL.

### **Q: Khi chuyá»ƒn tá»« ngrok sang production cÃ³ cáº§n lÃ m gÃ¬?**
A: **CÃ“**, pháº£i:
   1. Cáº­p nháº­t biáº¿n mÃ´i trÆ°á»ng trÃªn Railway
   2. Cáº­p nháº­t IPN URL trong VNPay Portal
   3. Redeploy payment service

### **Q: LÃ m sao kiá»ƒm tra IPN cÃ³ hoáº¡t Ä‘á»™ng khÃ´ng?**
A: Kiá»ƒm tra log cá»§a payment service sau khi thanh toÃ¡n:
   - Log "VNPay IPN received:" â†’ IPN Ä‘Ã£ nháº­n
   - Log "âœ“ VNPay IPN signature verified" â†’ Signature Ä‘Ãºng
   - Log "âœ“ Published payment success event" â†’ Xá»­ lÃ½ thÃ nh cÃ´ng

### **Q: IPN bá»‹ lá»—i signature, sai á»Ÿ Ä‘Ã¢u?**
A: Kiá»ƒm tra:
   1. VNPAY_HASH_SECRET Ä‘Ãºng chÆ°a
   2. IPN URL trong Portal cÃ³ Ä‘Ãºng khÃ´ng
   3. URL cÃ³ bá»‹ redirect (www vs non-www, http vs https)

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
## 4ï¸âƒ£ CHECKLIST DEPLOY PRODUCTION
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

Railway (Payment Service):
â–¡ Set VNPAY_RETURN_URL=https://sgu-cnpm-foodfast.vercel.app/payment-result
â–¡ Set VNPAY_IPN_URL=https://api-gateway-service-production-04a1.up.railway.app/api/payments/vnpay_ipn
â–¡ Set FRONTEND_URL=https://sgu-cnpm-foodfast.vercel.app
â–¡ Redeploy payment service

VNPay Sandbox Portal:
â–¡ Login https://sandbox.vnpayment.vn/merchantv2/
â–¡ VÃ o Cáº¥u hÃ¬nh â†’ URL IPN
â–¡ Nháº­p: https://api-gateway-service-production-04a1.up.railway.app/api/payments/vnpay_ipn
â–¡ LÆ°u láº¡i

Test:
â–¡ Táº¡o Ä‘Æ¡n hÃ ng má»›i
â–¡ Thanh toÃ¡n qua VNPay
â–¡ Kiá»ƒm tra redirect vá» Vercel frontend
â–¡ Kiá»ƒm tra log payment service nháº­n IPN
â–¡ Kiá»ƒm tra order status Ä‘Æ°á»£c update

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
## 5ï¸âƒ£ TROUBLESHOOTING
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

### **Lá»—i: Payment thÃ nh cÃ´ng nhÆ°ng order khÃ´ng update**
â†’ Kiá»ƒm tra IPN URL cÃ³ Ä‘Ãºng trong VNPay Portal
â†’ Kiá»ƒm tra log payment service cÃ³ nháº­n IPN khÃ´ng

### **Lá»—i: Return vá» frontend nhÆ°ng khÃ´ng cÃ³ order ID**
â†’ Kiá»ƒm tra VNPAY_RETURN_URL cÃ³ Ä‘Ãºng format
â†’ Kiá»ƒm tra frontend cÃ³ route /payment-result

### **Lá»—i: IPN signature invalid**
â†’ Kiá»ƒm tra VNPAY_HASH_SECRET
â†’ Kiá»ƒm tra IPN URL khÃ´ng bá»‹ redirect (301/302)

### **Lá»—i: Frontend khÃ´ng nháº­n Ä‘Æ°á»£c káº¿t quáº£ thanh toÃ¡n**
â†’ Kiá»ƒm tra FRONTEND_URL cÃ³ Ä‘Ãºng
â†’ Kiá»ƒm tra frontend cÃ³ xá»­ lÃ½ route /payment-result

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
âœ… HOÃ€N Táº¤T Cáº¤U HÃŒNH
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

