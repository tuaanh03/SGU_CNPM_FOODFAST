â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ”´ VNPAY IPN ROUTING 404 - DEBUG VÃ€ Sá»¬A Lá»–I
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

## âŒ TRIá»†U CHá»¨NG

Test VNPay IPN endpoint:
```bash
curl "https://api-gateway-service-production-04a1.up.railway.app/api/payments/vnpay_ipn?test=1" -v
```

**Response:**
```json
{"success":false,"message":"Route not found"}
```

**Váº¥n Ä‘á»:** Route `/api/payments/vnpay_ipn` tráº£ vá» 404 Not Found

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

## ğŸ” NGUYÃŠN NHÃ‚N

### Váº¥n Ä‘á» 1: Conflict giá»¯a `/api/payment` vÃ  `/api/payments`

**Express routing vá»›i `server.use()` match PREFIX:**

```typescript
// âŒ CÅ¨ - Bá»Š CONFLICT
server.use("/api/payment", authenticateToken, paymentServiceProxy);  // Line 1
server.use("/api/payments/vnpay_ipn", paymentServiceProxy);          // Line 2
```

**Váº¥n Ä‘á»:**
- Request: `/api/payments/vnpay_ipn`
- Express check route **theo thá»© tá»± khai bÃ¡o**
- Line 1: `/api/payment` â†’ Express check xem `/api/payments/vnpay_ipn` cÃ³ **START WITH** `/api/payment` khÃ´ng?
  - âœ… CÃ“! (`/api/payment` lÃ  prefix cá»§a `/api/payments`)
  - â†’ **Route 1 match! Forward Ä‘áº¿n Payment Service**
  - â†’ NhÆ°ng cÃ³ `authenticateToken` middleware â†’ **401 Unauthorized** (náº¿u khÃ´ng cÃ³ token)

**Hoáº·c náº¿u cÃ³ token:**
- Forward Ä‘áº¿n Payment Service vá»›i path: `/payments/vnpay_ipn`
- Payment Service khÃ´ng cÃ³ route `/ments/vnpay_ipn` (vÃ¬ Ä‘Ã£ remove `/api/payment`)
- â†’ **404 Not Found** tá»« Payment Service

### Váº¥n Ä‘á» 2: Path transformation khÃ´ng Ä‘Ãºng

**Request flow CÅ¨:**
```
1. Client request: GET /api/payments/vnpay_ipn
                          â†“
2. API Gateway: server.use("/api/payment", ...) matches
                          â†“
3. proxyReqPathResolver: remove "/api"
   /api/payments/vnpay_ipn â†’ /payments/vnpay_ipn
                          â†“
4. Forward to Payment Service: /payments/vnpay_ipn
                          â†“
5. Payment Service: server.use("/payment", paymentRoute)
   Path doesn't match! (Ä‘ang tÃ¬m /payment/*, nhÆ°ng nháº­n /payments/*)
                          â†“
6. âŒ 404 Not Found
```

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

## âœ… GIáº¢I PHÃP

### Chiáº¿n lÆ°á»£c: TÃ¡ch riÃªng `/api/payments` vÃ  `/api/payment`

**LÃ½ do:**
- `/api/payments/*` â†’ VNPay callbacks (public, no auth)
- `/api/payment/*` â†’ API endpoints (protected, with auth)
- 2 routes khÃ¡c nhau hoÃ n toÃ n â†’ khÃ´ng conflict

### Sá»­a API Gateway Routing

**File: `backend/services/api-gateway/src/server.ts`**

```typescript
// ==================== PAYMENT SERVICE ROUTES ====================

// âš ï¸ QUAN TRá»ŒNG: Route order vÃ  path matching
// Express.use() matches PREFIX, nÃªn cáº§n tÃ¡ch riÃªng /api/payments vÃ  /api/payment

// 1. VNPay Callbacks - Public routes (NO AUTHENTICATION)
// VNPay IPN endpoint - /api/payments/* (plural "payments")
server.use("/api/payments", paymentServiceProxy);

// VNPay Return URL - /vnpay_return (khÃ´ng cÃ³ /api prefix)
server.use("/vnpay_return", paymentServiceProxy);

// 2. Payment API endpoints - Protected routes (WITH AUTHENTICATION)
// Payment API - /api/payment/* (singular "payment")
server.use("/api/payment", authenticateToken, paymentServiceProxy);

console.log('âœ… Payment routes configured:');
console.log('  - /api/payments/* â†’ Payment Service (NO AUTH - includes /vnpay_ipn)');
console.log('  - /vnpay_return â†’ Payment Service (NO AUTH - user redirect)');
console.log('  - /api/payment/* â†’ Payment Service (WITH AUTH - API calls)');

// ================================================================
```

**Path transformation (Ä‘Ã£ cÃ³ sáºµn):**
```typescript
const paymentServiceProxy = proxy(config.paymentServiceUrl, {
    proxyReqPathResolver: (req) => {
        // VNPay return URL: giá»¯ nguyÃªn path
        if (req.originalUrl.startsWith("/vnpay_return")) {
            console.log(`[Payment Proxy] VNPay Return: ${req.originalUrl} â†’ ${req.originalUrl}`);
            return req.originalUrl;
        }

        // CÃ¡c routes khÃ¡c: remove /api prefix
        const newPath = req.originalUrl.replace(/^\/api/, "");
        console.log(`[Payment Proxy] API Route: ${req.originalUrl} â†’ ${newPath}`);
        return newPath;
    },
    ...
});
```

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

## ğŸ”„ REQUEST FLOW Má»šI (ÄÃšNG)

### Flow 1: VNPay IPN

```
1. VNPay gá»i: GET /api/payments/vnpay_ipn?vnp_TxnRef=xxx&...
                    â†“
2. API Gateway:
   - Check route: server.use("/api/payments", paymentServiceProxy)
   - âœ… MATCH! ("/api/payments" lÃ  prefix cá»§a "/api/payments/vnpay_ipn")
   - âœ… KHÃ”NG CÃ“ authenticateToken middleware
                    â†“
3. proxyReqPathResolver:
   - Original URL: /api/payments/vnpay_ipn
   - Remove /api: /payments/vnpay_ipn
   - Log: [Payment Proxy] API Route: /api/payments/vnpay_ipn â†’ /payments/vnpay_ipn
                    â†“
4. Forward to Payment Service:
   - URL: http://payment-service:4000/payments/vnpay_ipn?vnp_TxnRef=xxx&...
                    â†“
5. Payment Service (server.ts):
   - Route: server.use("/payments", paymentRoute)
   - Path: /payments/vnpay_ipn
   - âœ… MATCH!
                    â†“
6. Payment Route (payment.routes.ts):
   - Route: paymentRoute.get("/vnpay_ipn", asyncHandler(vnpayIPN))
   - Combined: /payments + /vnpay_ipn = /payments/vnpay_ipn
   - âœ… MATCH!
                    â†“
7. Controller: vnpayIPN()
   - Verify signature
   - Update PaymentIntent
   - Publish Kafka event
   - âœ… Return success
```

### Flow 2: Frontend API Call (vá»›i auth)

```
1. Frontend gá»i: GET /api/payment/payment-url/order_xxx
   Headers: Authorization: Bearer <jwt_token>
                    â†“
2. API Gateway:
   - Check route: server.use("/api/payment", authenticateToken, paymentServiceProxy)
   - âœ… MATCH! ("/api/payment" lÃ  prefix cá»§a "/api/payment/payment-url/...")
   - âœ… CÃ“ authenticateToken middleware â†’ verify JWT
                    â†“
3. authenticateToken middleware:
   - Verify JWT token
   - Attach user to req.user
   - âœ… Next()
                    â†“
4. proxyReqPathResolver:
   - Original URL: /api/payment/payment-url/order_xxx
   - Remove /api: /payment/payment-url/order_xxx
                    â†“
5. Forward to Payment Service:
   - URL: http://payment-service:4000/payment/payment-url/order_xxx
   - Headers: x-user-id, x-user-email, x-user-role
                    â†“
6. Payment Service (server.ts):
   - Route: server.use("/payment", paymentRoute)
   - Path: /payment/payment-url/order_xxx
   - âœ… MATCH!
                    â†“
7. Payment Route:
   - Route: paymentRoute.get("/payment-url/:orderId", asyncHandler(getPaymentUrl))
   - Combined: /payment + /payment-url/:orderId = /payment/payment-url/:orderId
   - âœ… MATCH!
                    â†“
8. Controller: getPaymentUrl()
   - Get PaymentIntent from DB
   - âœ… Return payment URL
```

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

## ğŸ“Š ROUTING TABLE

### API Gateway Routes (Thá»© tá»± quan trá»ng!)

| Route Pattern          | Middleware         | Target Service    | Purpose                    |
|------------------------|-------------------|-------------------|----------------------------|
| `/api/payments/*`      | âŒ No auth        | Payment Service   | VNPay IPN callbacks        |
| `/vnpay_return`        | âŒ No auth        | Payment Service   | VNPay return URL           |
| `/api/payment/*`       | âœ… Auth required  | Payment Service   | Payment API endpoints      |
| `/api/auth/*`          | âŒ No auth        | User Service      | Authentication             |
| `/api/order/*`         | âœ… Auth required  | Order Service     | Order operations           |
| `/api/cart/*`          | âœ… Auth required  | Cart Service      | Cart operations            |
| `/api/products/*`      | âŒ No auth        | Product Service   | Product listing            |
| `/api/stores/*`        | âŒ No auth        | Restaurant Svc    | Restaurant listing         |

### Payment Service Routes

| Route Pattern          | Combined Path              | Handler        |
|------------------------|----------------------------|----------------|
| `/payments/vnpay_ipn`  | /payments + /vnpay_ipn     | vnpayIPN()     |
| `/payment/payment-url/:orderId` | /payment + /payment-url/:orderId | getPaymentUrl() |
| `/vnpay_return`        | / + /vnpay_return          | vnpayReturn()  |

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

## ğŸ§ª TESTING

### Test 1: VNPay IPN endpoint (Public, no auth)

```bash
# Test from command line
curl "https://api-gateway-service-production-04a1.up.railway.app/api/payments/vnpay_ipn?test=1" -v
```

**Káº¿t quáº£ mong Ä‘á»£i:**
```
< HTTP/2 200
{
  "RspCode": "97",
  "Message": "Invalid Checksum"
}
```

**Giáº£i thÃ­ch:**
- âœ… Status 200 (khÃ´ng 404!) â†’ Route hoáº¡t Ä‘á»™ng
- âœ… RspCode 97 = Invalid Checksum â†’ Signature verification failed (expected - vÃ¬ test khÃ´ng cÃ³ signature Ä‘Ãºng)
- âœ… Chá»©ng tá» request Ä‘Ã£ Ä‘áº¿n Payment Service vÃ  Ä‘Æ°á»£c xá»­ lÃ½

**Náº¿u váº«n 404:**
â†’ API Gateway chÆ°a deploy code má»›i hoáº·c cÃ³ váº¥n Ä‘á» khÃ¡c

### Test 2: Payment URL endpoint (Protected, with auth)

```bash
# Test with valid JWT token
curl "https://api-gateway-service-production-04a1.up.railway.app/api/payment/payment-url/order_xxx" \
  -H "Authorization: Bearer <your_jwt_token>" -v
```

**Káº¿t quáº£ mong Ä‘á»£i:**
- âœ… Status 200: Tráº£ vá» payment URL
- âŒ Status 401: Token khÃ´ng há»£p lá»‡ (expected náº¿u khÃ´ng cÃ³ token)
- âŒ Status 404: Order khÃ´ng tá»“n táº¡i

### Test 3: Kiá»ƒm tra logs

**API Gateway logs (sau khi deploy):**
```
âœ… Payment routes configured:
  - /api/payments/* â†’ Payment Service (NO AUTH - includes /vnpay_ipn)
  - /vnpay_return â†’ Payment Service (NO AUTH - user redirect)
  - /api/payment/* â†’ Payment Service (WITH AUTH - API calls)

[Payment Proxy] API Route: /api/payments/vnpay_ipn â†’ /payments/vnpay_ipn
```

**Payment Service logs:**
```
âœ… VNPay IPN received: { test: '1' }
âŒ Invalid signature in VNPay IPN
```

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

## ğŸš€ DEPLOYMENT CHECKLIST

### BÆ°á»›c 1: Commit vÃ  push code

```bash
cd backend/services/api-gateway
git add src/server.ts
git commit -m "fix: TÃ¡ch riÃªng /api/payments vÃ  /api/payment Ä‘á»ƒ trÃ¡nh routing conflict"
git push
```

### BÆ°á»›c 2: Deploy trÃªn Railway

**API Gateway:**
- Railway sáº½ tá»± Ä‘á»™ng detect git push vÃ  rebuild
- Hoáº·c manual trigger: Settings â†’ Redeploy

**Kiá»ƒm tra deployment:**
- Click vÃ o service â†’ Deployments
- Äá»£i build xong (âœ… Success)
- Click "View Logs"

### BÆ°á»›c 3: Verify logs

**Trong API Gateway logs, pháº£i tháº¥y:**
```
âœ… Payment routes configured:
  - /api/payments/* â†’ Payment Service (NO AUTH - includes /vnpay_ipn)
```

**Náº¿u khÃ´ng tháº¥y:**
â†’ Code chÆ°a deploy hoáº·c Ä‘ang dÃ¹ng cache cÅ©

### BÆ°á»›c 4: Test endpoint

```bash
curl "https://api-gateway-service-production-04a1.up.railway.app/api/payments/vnpay_ipn?test=1" -v
```

**Káº¿t quáº£ mong Ä‘á»£i: 200 OK (khÃ´ng 404!)**

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

## ğŸ› TROUBLESHOOTING

### Váº¥n Ä‘á»: Váº«n 404 sau khi deploy

**Kiá»ƒm tra:**

1. **Code Ä‘Ã£ deploy chÆ°a?**
   ```bash
   # Check latest commit on Railway
   # Settings â†’ Service â†’ Connected Repo â†’ View on GitHub
   ```

2. **Logs cÃ³ Ä‘Ãºng khÃ´ng?**
   ```
   # Pháº£i tháº¥y trong logs:
   âœ… Payment routes configured:
     - /api/payments/* â†’ ...
   ```

3. **Cache issue?**
   ```bash
   # Force redeploy
   Railway â†’ Settings â†’ Redeploy
   ```

4. **Thá»­ direct call Payment Service (Ä‘á»ƒ isolate issue):**
   ```bash
   # Náº¿u cÃ³ public URL cá»§a Payment Service
   curl "https://payment-service-xxx.railway.app/payments/vnpay_ipn?test=1" -v

   # Káº¿t quáº£ mong Ä‘á»£i: 200 OK
   # â†’ Payment Service OK, issue á»Ÿ API Gateway
   ```

### Váº¥n Ä‘á»: 401 Unauthorized

**NguyÃªn nhÃ¢n:** Route váº«n bá»‹ `authenticateToken` cháº·n

**Kiá»ƒm tra:**
- Route `/api/payments` cÃ³ Ä‘áº·t **TRÆ¯á»šC** `/api/payment` khÃ´ng?
- Route `/api/payments` cÃ³ middleware `authenticateToken` khÃ´ng? (pháº£i KHÃ”NG CÃ“)

### Váº¥n Ä‘á»: 500 Internal Server Error

**NguyÃªn nhÃ¢n:** Proxy error hoáº·c Payment Service down

**Kiá»ƒm tra:**
- Payment Service cÃ³ cháº¡y khÃ´ng? (check Railway dashboard)
- Logs cá»§a Payment Service cÃ³ lá»—i khÃ´ng?

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

## ğŸ“‹ TÃ“M Táº®T THAY Äá»”I

### Files Ä‘Ã£ sá»­a:

**1. `backend/services/api-gateway/src/server.ts`**

**Thay Ä‘á»•i:**
- âœ… TÃ¡ch route `/api/payments` (VNPay callbacks, no auth)
- âœ… Giá»¯ route `/api/payment` (API endpoints, with auth)
- âœ… ThÃªm logging chi tiáº¿t trong proxy
- âœ… Cáº­p nháº­t fallback handler Ä‘á»ƒ debug

**TrÆ°á»›c:**
```typescript
server.use("/api/payments/vnpay_ipn", paymentServiceProxy);  // âŒ Conflict
server.use("/api/payment", authenticateToken, paymentServiceProxy);
```

**Sau:**
```typescript
server.use("/api/payments", paymentServiceProxy);  // âœ… No conflict, no auth
server.use("/api/payment", authenticateToken, paymentServiceProxy);  // âœ… With auth
```

### VNPay Sandbox Configuration:

**IPN URL:** (khÃ´ng thay Ä‘á»•i)
```
https://api-gateway-service-production-04a1.up.railway.app/api/payments/vnpay_ipn
```

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

## âœ… Káº¾T LUáº¬N

**Váº¥n Ä‘á» gá»‘c:**
- Route conflict giá»¯a `/api/payment` vÃ  `/api/payments`
- Express prefix matching gÃ¢y ra lá»—i routing

**Giáº£i phÃ¡p:**
- TÃ¡ch riÃªng 2 routes hoÃ n toÃ n khÃ¡c nhau
- `/api/payments/*` â†’ VNPay callbacks (public)
- `/api/payment/*` â†’ API endpoints (protected)

**Sau khi sá»­a:**
- âœ… VNPay IPN endpoint hoáº¡t Ä‘á»™ng (200 OK)
- âœ… Payment API endpoints váº«n Ä‘Æ°á»£c báº£o vá»‡ bá»Ÿi JWT
- âœ… KhÃ´ng conflict routing

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

