# Current Payment Workflow - Data Flow Analysis

## ðŸ”„ Complete Flow When Testing `create-from-cart` API

### **Overview Diagram**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Postman  â”‚ â”€â”€â”€â”€â”€â”€â”€â”€>â”‚ Order Service â”‚ â”€â”€â”€â”€â”€â”€â”€â”€>â”‚ Payment Service  â”‚ â”€â”€â”€â”€â”€â”€â”€â”€>â”‚  VNPay   â”‚
â”‚          â”‚          â”‚               â”‚          â”‚                  â”‚          â”‚   PSP    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚                       â”‚                            â”‚                          â”‚
     â”‚                       â”‚                            â”‚                          â”‚
     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    Kafka Topics:
                              order.create, payment.event
```

---

## ðŸ“Š Detailed Data Flow

### **Step 1: Postman â†’ Order Service**

**Endpoint:** `POST /api/orders/create-from-cart`

**Request Body:**
```json
{
  "storeId": "store-123",
  "deliveryAddress": "123 Nguyen Hue St, District 1, HCMC",
  "contactPhone": "0901234567",
  "note": "No onions please"
}
```

**Headers:**
```
Authorization: Bearer eyJhbGciOiJIUzI1NiIs...
Content-Type: application/json
```

**What Order Service Does:**
1. Extract `userId` from JWT token
2. Fetch cart from Cart Service (Redis)
3. Validate items through MenuItemRead
4. Calculate total price
5. Create order in PostgreSQL
6. **Publish event to Kafka topic `order.create`**

---

### **Step 2: Order Service â†’ Payment Service (via Kafka)**

**Kafka Topic:** `order.create`

**Message Data Structure:**
```json
{
  "orderId": "abc12345-1234-5678-9abc-123456789012",
  "userId": "user-uuid-123",
  "items": [
    {
      "productId": "prod-001",
      "quantity": 2
    },
    {
      "productId": "prod-002", 
      "quantity": 1
    }
  ],
  "totalPrice": 150000,
  "timestamp": "2025-10-28T10:30:45.123Z"
}
```

**Payment Service Kafka Consumer** (file: `payment-service/src/utils/kafka.ts`) receives this event.

---

### **Step 3: Payment Service â†’ VNPay PSP**

**What Payment Service Does:**

1. **Receives Kafka message** from `order.create` topic
2. **Extracts data:**
   ```typescript
   const { orderId, userId, totalPrice, items } = orderData;
   ```

3. **Generates order description:**
   ```typescript
   const orderDescription = items && items.length > 0
     ? `Order ${orderId} - ${items.length} items`
     : `Order ${orderId}`;
   ```

4. **Calls `processPayment()` function** to create VNPay URL

#### **VNPay Request Parameters** (Generated by Payment Service)

```typescript
// File: payment-service/src/utils/vnpay.ts

const txnRef = `${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;
// Example: "1698483045123-a1b2c3d4e"

const createDate = new Date()
  .toISOString()
  .replace(/[-:TZ]/g, "")
  .slice(0, 14);
// Example: "20251028103045"

const rawParams = {
  vnp_Version: "2.1.0",
  vnp_Command: "pay",
  vnp_TmnCode: "YOUR_TMN_CODE",           // From env variable
  vnp_Locale: "vn",
  vnp_CurrCode: "VND",
  vnp_TxnRef: "1698483045123-a1b2c3d4e", // Unique transaction reference
  vnp_OrderInfo: "Order abc12345-1234-5678-9abc-123456789012 - 3 items",
  vnp_OrderType: "other",
  vnp_Amount: "15000000",                  // 150000 * 100 (VNPay format)
  vnp_ReturnUrl: "http://localhost:3001/vnpay_return",
  vnp_IpAddr: "127.0.0.1",
  vnp_CreateDate: "20251028103045"
};
```

5. **Generates HMAC SHA512 signature:**
   ```typescript
   const sortedKeys = Object.keys(rawParams).sort();
   const params = new URLSearchParams();
   for (const key of sortedKeys) {
     params.append(key, rawParams[key]);
   }
   
   const signData = params.toString();
   const signed = crypto
     .createHmac("sha512", VNPAY_HASH_SECRET)
     .update(Buffer.from(signData, "utf-8"))
     .digest("hex");
   
   params.append("vnp_SecureHash", signed);
   ```

6. **Constructs VNPay Payment URL:**
   ```
   https://sandbox.vnpayment.vn/paymentv2/vpcpay.html?
     vnp_Amount=15000000&
     vnp_Command=pay&
     vnp_CreateDate=20251028103045&
     vnp_CurrCode=VND&
     vnp_IpAddr=127.0.0.1&
     vnp_Locale=vn&
     vnp_OrderInfo=Order%20abc12345%20-%203%20items&
     vnp_OrderType=other&
     vnp_ReturnUrl=http%3A%2F%2Flocalhost%3A3001%2Fvnpay_return&
     vnp_TmnCode=YOUR_TMN_CODE&
     vnp_TxnRef=1698483045123-a1b2c3d4e&
     vnp_Version=2.1.0&
     vnp_SecureHash=a1b2c3d4e5f6g7h8i9j0k1l2m3n4o5p6q7r8s9t0...
   ```

**âš ï¸ IMPORTANT:** Payment Service **DOES NOT** directly call VNPay API. It only **generates the URL**. VNPay is a **redirect-based payment gateway**.

---

### **Step 4: Payment Service â†’ Order Service (via Kafka)**

**Kafka Topic:** `payment.event`

**Message Data Structure (Pending Status):**
```json
{
  "orderId": "abc12345-1234-5678-9abc-123456789012",
  "userId": "user-uuid-123",
  "email": "system@vnpay.com",
  "amount": 150000,
  "item": "Order abc12345-1234-5678-9abc-123456789012 - 3 items",
  "paymentStatus": "pending",
  "paymentIntentId": "1698483045123-a1b2c3d4e",
  "paymentUrl": "https://sandbox.vnpayment.vn/paymentv2/vpcpay.html?..."
}
```

**Order Service Kafka Consumer** receives this event and:
- Updates order status to `pending`
- Logs payment URL (frontend can poll or listen via WebSocket)

---

### **Step 5: VNPay â†’ Payment Service (Callback)**

**When user completes payment on VNPay**, VNPay redirects back to:

**Endpoint:** `GET http://localhost:3001/vnpay_return`

**VNPay Callback Query Parameters:**
```
?vnp_Amount=15000000
&vnp_BankCode=NCB
&vnp_BankTranNo=VNP01234567
&vnp_CardType=ATM
&vnp_OrderInfo=Order%20abc12345-1234-5678-9abc-123456789012%20-%203%20items
&vnp_PayDate=20251028103145
&vnp_ResponseCode=00
&vnp_TmnCode=YOUR_TMN_CODE
&vnp_TransactionNo=14012345
&vnp_TransactionStatus=00
&vnp_TxnRef=1698483045123-a1b2c3d4e
&vnp_SecureHash=xyz123abc456...
```

**VNPay Response Codes:**
- `00` = Success
- `07` = Transaction suspicious (trá»« tiá»n thÃ nh cÃ´ng, chá» duyá»‡t)
- `09` = Card not registered for Internet Banking
- `10` = Invalid authentication (3 times)
- `11` = Transaction timeout
- `12` = Card locked
- `13` = OTP authentication failed
- `24` = User cancelled transaction
- `51` = Insufficient balance
- `65` = Transaction limit exceeded
- `75` = Payment gateway is under maintenance
- `79` = Transaction failed

---

### **Step 6: Payment Service Processes VNPay Callback**

**What Payment Service Does:**

1. **Extracts callback data:**
   ```typescript
   const vnp_ResponseCode = req.query.vnp_ResponseCode as string; // "00"
   const vnp_TxnRef = req.query.vnp_TxnRef as string; // "1698483045123-a1b2c3d4e"
   const vnp_Amount = req.query.vnp_Amount as string; // "15000000"
   const vnp_OrderInfo = req.query.vnp_OrderInfo as string;
   ```

2. **Extracts orderId from vnp_OrderInfo:**
   ```typescript
   const orderIdMatch = vnp_OrderInfo?.match(/Order\s+([a-f0-9-]+)/);
   const orderId = orderIdMatch ? orderIdMatch[1] : vnp_TxnRef;
   // Result: "abc12345-1234-5678-9abc-123456789012"
   ```

3. **Determines payment status:**
   ```typescript
   const paymentStatus = vnp_ResponseCode === "00" ? "success" : "failed";
   ```

4. **Converts amount back:**
   ```typescript
   const amount = parseInt(vnp_Amount || "0") / 100; // 150000
   ```

5. **Publishes payment result event to Kafka:**

---

### **Step 7: Payment Service â†’ Order Service (via Kafka)**

**Kafka Topic:** `payment.event`

**Message Data Structure (Success/Failed Status):**
```json
{
  "orderId": "abc12345-1234-5678-9abc-123456789012",
  "userId": "",
  "email": "system@vnpay.com",
  "amount": 150000,
  "item": "VNPay Payment",
  "paymentStatus": "success",  // or "failed"
  "paymentIntentId": "1698483045123-a1b2c3d4e"
}
```

**Order Service Kafka Consumer** receives this event and:
- Updates order status to `success` or `failed`
- Logs the result

---

### **Step 8: Payment Service Redirects User**

**Payment Service redirects user to frontend:**
```typescript
const frontendUrl = process.env.FRONTEND_URL || "http://localhost:3000";
const redirectUrl = `${frontendUrl}/payment-result?status=${paymentStatus}&orderId=${orderId}&ref=${vnp_TxnRef}`;

res.redirect(redirectUrl);
```

**Example Redirect URL:**
```
http://localhost:3000/payment-result?
  status=success&
  orderId=abc12345-1234-5678-9abc-123456789012&
  ref=1698483045123-a1b2c3d4e
```

---

## ðŸ“ Summary Table

| Step | From | To | Method | Content Sent |
|------|------|-----|--------|--------------|
| 1 | Postman | Order Service | HTTP POST | `{storeId, deliveryAddress, contactPhone, note}` + JWT token |
| 2 | Order Service | Payment Service | Kafka (`order.create`) | `{orderId, userId, items[], totalPrice, timestamp}` |
| 3 | Payment Service | VNPay | N/A (URL generation) | **Generates URL with params** (vnp_TmnCode, vnp_Amount, vnp_TxnRef, etc.) |
| 4 | Payment Service | Order Service | Kafka (`payment.event`) | `{orderId, paymentStatus: "pending", paymentUrl, paymentIntentId}` |
| 5 | VNPay | Payment Service | HTTP GET (callback) | `?vnp_ResponseCode, vnp_TxnRef, vnp_Amount, vnp_OrderInfo, etc.` |
| 6 | Payment Service | Order Service | Kafka (`payment.event`) | `{orderId, paymentStatus: "success"/"failed", paymentIntentId}` |
| 7 | Payment Service | Frontend | HTTP 302 Redirect | `?status, orderId, ref` |

---

## ðŸ”‘ Key Points

### **1. Payment Service DOES NOT call VNPay API directly**
- It only **generates a payment URL** with signed parameters
- VNPay is a **redirect-based** payment gateway
- User's browser makes the actual request to VNPay

### **2. Communication Flow:**
```
Order Service â”€(Kafka)â”€> Payment Service â”€(Generate URL)â”€> Frontend â”€(Redirect)â”€> VNPay
                                                                                      â”‚
Order Service <â”€(Kafka)â”€ Payment Service <â”€â”€â”€â”€â”€â”€(HTTP Callback)â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### **3. Data Sent to VNPay (via URL):**
```typescript
{
  vnp_Version: "2.1.0",
  vnp_Command: "pay",
  vnp_TmnCode: "YOUR_TMN_CODE",
  vnp_Locale: "vn",
  vnp_CurrCode: "VND",
  vnp_TxnRef: "1698483045123-a1b2c3d4e",      // Unique transaction ID
  vnp_OrderInfo: "Order abc12345 - 3 items",  // Order description
  vnp_OrderType: "other",
  vnp_Amount: "15000000",                      // Amount * 100
  vnp_ReturnUrl: "http://localhost:3001/vnpay_return",
  vnp_IpAddr: "127.0.0.1",
  vnp_CreateDate: "20251028103045",
  vnp_SecureHash: "a1b2c3d4e5f6..."           // HMAC SHA512 signature
}
```

### **4. Data Received from VNPay (callback):**
```typescript
{
  vnp_Amount: "15000000",
  vnp_BankCode: "NCB",
  vnp_BankTranNo: "VNP01234567",
  vnp_CardType: "ATM",
  vnp_OrderInfo: "Order abc12345 - 3 items",
  vnp_PayDate: "20251028103145",
  vnp_ResponseCode: "00",                      // "00" = Success
  vnp_TmnCode: "YOUR_TMN_CODE",
  vnp_TransactionNo: "14012345",
  vnp_TransactionStatus: "00",
  vnp_TxnRef: "1698483045123-a1b2c3d4e",      // Same as sent
  vnp_SecureHash: "xyz123abc456..."            // Verify signature
}
```

---

## âš ï¸ Issues with Current Implementation

### **1. Payment URL is sent via Kafka**
- âŒ **Problem:** Payment URL contains signature with timestamp, can expire
- âŒ **Problem:** URL is stored in event/logs, security risk
- âœ… **Solution:** Follow `PAYMENT_URL_GENERATION_GUIDE.md` - generate URL on-demand

### **2. No payment record in database**
- âŒ **Problem:** Cannot track payment history
- âŒ **Problem:** Cannot handle retries
- âŒ **Problem:** No idempotency check
- âœ… **Solution:** Create Payment Service database with `Payment` model

### **3. No signature verification on callback**
- âŒ **Problem:** Anyone can send fake callback to update order status
- âœ… **Solution:** Verify `vnp_SecureHash` before processing

### **4. No retry mechanism**
- âŒ **Problem:** If payment fails, user must create new order
- âœ… **Solution:** Implement retry payment endpoint

### **5. UserId not stored in payment callback**
- âŒ **Problem:** Cannot verify payment belongs to correct user
- âœ… **Solution:** Store payment intent in database with userId

---

## ðŸŽ¯ Next Steps (Follow PAYMENT_URL_GENERATION_GUIDE.md)

1. âœ… Create Payment Service database schema
2. âœ… Store payment records with `paymentIntentId`
3. âœ… Generate payment URL on-demand (not via Kafka)
4. âœ… Implement VNPay signature verification
5. âœ… Add retry payment endpoint
6. âœ… Implement idempotency check
7. âœ… Add payment expiry handling

---

## ðŸ“š References

- **VNPay Documentation:** https://sandbox.vnpayment.vn/apis/docs/
- **Current Guide:** `PAYMENT_URL_GENERATION_GUIDE.md`
- **Kafka Topics:**
  - `order.create` - Order Service â†’ Payment Service
  - `payment.event` - Payment Service â†’ Order Service

---

**Last Updated:** October 28, 2025

