# QUICK REFERENCE: Loki Labels & Dashboard Variables

## âœ… Tráº¡ng thÃ¡i: HOÃ€N THÃ€NH

## ğŸ“Š Labels cÃ³ sáºµn trong Loki

```
âœ… service  - TÃªn service (user-service, order-service, etc.)
âœ… level    - Log level (info, warn, error, debug)
âœ… method   - HTTP method (GET, POST, PUT, DELETE)
âœ… status   - HTTP status code (200, 201, 400, 404, 500)
```

## ğŸ¯ Dashboard Variables

### 1. Instance (Prometheus)
- **TÃªn**: instance
- **Label**: "Instance"
- **Datasource**: Prometheus
- **DÃ¹ng cho**: Filter metrics panels
- **Query**: `{instance="$instance"}`

### 2. Service (Loki)
- **TÃªn**: service
- **Label**: "Service"
- **Datasource**: Loki (bf49ghuftzrpcc)
- **DÃ¹ng cho**: Filter logs by service
- **Query**: `{service=~"$service"}`

### 3. Level (Loki)
- **TÃªn**: level
- **Label**: "Log Level"
- **Datasource**: Loki
- **Values**: info, warn, error, debug
- **Query**: `{level=~"$level"}`

### 4. Method (Loki)
- **TÃªn**: method
- **Label**: "HTTP Method"
- **Datasource**: Loki
- **Values**: GET, POST, PUT, DELETE, PATCH
- **Query**: `{method=~"$method"}`

### 5. Status (Loki)
- **TÃªn**: status
- **Label**: "HTTP Status"
- **Datasource**: Loki
- **Values**: 200, 201, 400, 404, 500, etc.
- **Query**: `{status=~"$status"}`

## ğŸ” LogQL Query Examples

### Basic Queries
```logql
# Táº¥t cáº£ logs cá»§a service
{service="order-service"}

# Logs theo level
{level="error"}

# Logs theo method
{method="POST"}

# Logs theo status
{status="500"}
```

### Combined Filters
```logql
# Service + Level
{service="order-service", level="error"}

# Service + Method + Status
{service="payment-service", method="POST", status="200"}

# Multi-service errors
{service=~"order-service|payment-service", level="error"}

# All errors (4xx, 5xx)
{status=~"4..|5.."}
```

### With Variables
```logql
# Sá»­ dá»¥ng dashboard variables
{service=~"$service", level=~"$level", method=~"$method", status=~"$status"}

# Service + text search
{service=~"$service"} |= "payment failed"

# Filter + parse JSON
{service="order-service"} | json | userId != ""
```

## ğŸ§ª Test Commands

### Check Loki Labels
```bash
curl -s "http://localhost:3100/loki/api/v1/labels" | jq -r '.data[]'
```

### Check Label Values
```bash
# Level values
curl -s "http://localhost:3100/loki/api/v1/label/level/values" | jq .

# Method values
curl -s "http://localhost:3100/loki/api/v1/label/method/values" | jq .

# Status values
curl -s "http://localhost:3100/loki/api/v1/label/status/values" | jq .

# Service values
curl -s "http://localhost:3100/loki/api/v1/label/service/values" | jq .
```

### Test Dashboard Variables
```bash
curl -s "http://admin:admin@localhost:3001/api/dashboards/uid/microservices-overview" | jq '.dashboard.templating.list[] | {name, label, datasource}'
```

### Query Logs
```bash
# Basic query
curl -G -s "http://localhost:3100/loki/api/v1/query_range" \
  --data-urlencode 'query={service="order-service"}' \
  --data-urlencode 'limit=10' | jq .

# With filters
curl -G -s "http://localhost:3100/loki/api/v1/query_range" \
  --data-urlencode 'query={service="order-service", level="error"}' \
  --data-urlencode 'limit=10' | jq .
```

## ğŸ”§ Troubleshooting

### Variables khÃ´ng load Ä‘Æ°á»£c
```bash
# 1. Check datasource UID
curl -s "http://admin:admin@localhost:3001/api/datasources" | jq -r '.[] | select(.type=="loki") | {name, uid}'

# 2. Verify trong dashboard JSON
grep "bf49ghuftzrpcc" grafana/dashboards/grafana-microservices-dashboard.json

# 3. Restart Grafana náº¿u cáº§n
docker-compose restart grafana
```

### Labels khÃ´ng xuáº¥t hiá»‡n
```bash
# 1. Check Promtail logs
docker logs promtail 2>&1 | tail -20

# 2. Check log format tá»« service
docker logs user-service 2>&1 | tail -1

# 3. Restart Promtail
docker-compose restart promtail

# 4. Wait 30s vÃ  check láº¡i
sleep 30 && curl -s "http://localhost:3100/loki/api/v1/labels" | jq .
```

## ğŸ“ Important URLs

- **Grafana**: http://localhost:3001 (admin/admin)
- **Loki API**: http://localhost:3100
- **Prometheus**: http://localhost:9090
- **Dashboard**: http://localhost:3001/d/microservices-overview

## ğŸš€ Sá»­ dá»¥ng Dashboard

1. Má»Ÿ Grafana: http://localhost:3001
2. Login: admin / admin
3. VÃ o "Microservices Overview Dashboard"
4. Chá»n filters:
   - Instance: order-service:3001 (cho metrics)
   - Service: order-service (cho logs)
   - Level: error (chá»‰ errors)
   - Method: POST (chá»‰ POST requests)
   - Status: 500 (chá»‰ 500 errors)

5. Káº¿t quáº£: Dashboard hiá»ƒn thá»‹ metrics vÃ  logs filtered theo cÃ¡c tiÃªu chÃ­ Ä‘Ã£ chá»n

## ğŸ“ Notes

- **Datasource UID**: bf49ghuftzrpcc (QUAN TRá»ŒNG - Ä‘á»«ng thay Ä‘á»•i)
- **Label cardinality**: level (4), method (7), status (~20), service (~30)
- **Log format**: JSON vá»›i fields: timestamp, level, service, method, path, status
- **Promtail pipeline**: Parse direct JSON (khÃ´ng cÃ³ Docker wrapper)

---
Last updated: 16/11/2025
Status: âœ… Production Ready

